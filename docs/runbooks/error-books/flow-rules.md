# 错题本 — 通用/流程（每次必读）

### 记录规则

- **流程条目**（DEV-X）：❌ 错误做法 + ✅ 正确做法 + 一句话解释，控制在 **5 行以内**
- 复犯记录只追加频率标记（🟡×N / 🔴×N），不在 ❌ 里堆叠每次场景描述
- 详细复盘放 `../postmortems/`，这里只放链接

### DEV-4 跳过流程门控直接编码 `🔴高频×17`

❌ 跳过门控链中任一环节直接编码（评审/串讲/CR/归零/角色加载/环境指令均有复犯记录）；CR 甩给子 agent 后只挑一两条修，不自己逐文件复核
✅ 完整门控链：IR→SR→AR→串讲→测试设计→编码→CR→P0/P1归零→更新进度。**CR 必须用 Task 启独立 agent，不能自己审自己**。**子 agent CR 输出是辅助视角，主 agent 必须自己逐文件过 checklist，逐条标注 ✅/❌**。**第一次改文件前必须确认：用户指定的工作环境（worktree/分支）是否已就绪**。**每个门控步骤完成后，报告结果并等用户确认再进入下一步，不得连续自推**
> ×17：M6.2-P2 编码完成后把 CR 甩给子 agent，只挑了 B1 修，没自己逐文件过 checklist；美学审核合并到 CR 里一笔带过。根因：编码惯性，测试通过就急着往下走。

### DEV-5 实施不遵循 TDD 文档 `🟢`

❌ TDD 定义了接口格式，实施时自己改了字段名
✅ 严格按 TDD 实施，需要改设计先更新 TDD 再改代码
> TDD 是契约，改契约需要走流程。

### DEV-6 改代码不 grep 引用 + 不复用 pattern + 不对照 TDD `🟡中频×3`

❌ 改了签名/返回值不 grep 全量引用 → 下游断裂；不 grep 同类实现从零写 → Code Review 出 P1；写完不对照 TDD → 字段名偏离；dormant/废弃子系统只改主调用链，遗漏 dev API/测试等次要入口
✅ 改前 grep 同类 pattern 复用 → 改前 grep 全量引用确认 → 改后逐条对照 TDD → 改后涟漪推演（变量可达性+mock 同步）。**dormant/废弃操作额外要求：`grep -rn "函数名" server/` 穷举全部入口（主调用链+dev API+测试+import），逐个确认处置**。**写新函数同样适用：新增 service/handler 前先 Read 同文件已有函数，确认事务模式（commit/flush/不管）、错误返回格式、命名惯例，对齐后再写。涉及外部 API 调用（embedding/LLM/HTTP）的事务，还必须跨文件 grep 同类操作的失败处理模式（rollback/savepoint/delete），不能只看同文件的简单 seed 函数**
> 详见 [postmortem-dev-bug-6.md](../postmortems/postmortem-dev-bug-6.md)、[postmortem-dev-bug-11.md](../postmortems/postmortem-dev-bug-11.md)。×3：策略 dormant 改 decide() 签名只改 tick()，遗漏 dev_trigger.py 解包崩溃（P0）+ dev API/测试仍活跃（P1×3）

### DEV-7 测试验证偷懒：pytest 冒充 ST / E2E 不跑 / 旧服务器没重启 `🟡中频×2`

❌ pytest 全绿就声称"ST 通过"；E2E 脚本写了不当场跑就 commit；代码改了但旧服务器还在跑，测试结果不可信
✅ ST = 真实服务器+真实网络，不是 pytest；E2E 写完必须当场跑看到真实响应；改了 server/*.py → kill 旧进程+重启
> 详见 [postmortem-dev-bug-12.md](../postmortems/postmortem-dev-bug-12.md)

### DEV-24 更新文档只改局部不扫全文 `🟡×2`

❌ 用户说"更新 README"，只改了截图和架构图，没扫描全文 → 特性列表、计划中、测试数字、项目结构、文档链接全部过时
✅ 更新任何文档前先全文扫描，列出所有过时点，一次性全部更新。"更新"= 全面审查一致性，不是只改最明显的一处
> ×2：往带"记录规则"头部的文件追加内容时，未先 Read 前 10 行确认格式约束（行数上限/分类归属/条目模板），写出超规范大块。**补丁：往任何规范文件追加前，先读头部记录规则再动手**

### DEV-29 P0/P1 修复列表漏项 + 执行节奏碎片化 `🟢`

❌ Code Review 列了 5 个 P1，只修了 4 个漏掉 P1-5；独立修改逐个做每个停一次；ST 脚本碎片追加 Edit 7-8 次卡在匹配不唯一；独立文件更新串行 6 次来回
✅ P0/P1 列表逐条核销不漏项；多个独立修改一条消息并行发出；新建长文件 Write 主体+最多 1-2 次 Edit 补尾；独立文件更新并行

### DEV-32 门控表缺视觉序号 → TDD 被误当里程碑起始动作 `🟢`

❌ 用户说"启动 M6 规划"，AI 看到门控表里 AR 列写着 `TDD-M*-xxx.md`，条件反射"先写 TDD"，跳过了 IR 和 SR
✅ 门控表已修复：三行加 ①②③ 序号，AR 行 TDD 旁加括号备注"IR+SR 通过后才写"

### DEV-33 pytest 冒充 ST（DEV-7 复犯）+ P0/P1 归零跳过归因 `🟡中频×6`

❌ pytest 冒充 ST；归零时跳过归因/全量回归/二次 CR；CR 只看修复 diff 不看全部改动
✅ ST = 真实服务器 + e2e 脚本；归零四步：修复→全量回归→二次 CR（独立 agent，审全部改动文件）→归因声明，缺一不可

### DEV-38 编码前跳过 AR → 安全/异常/配置全面失守 `🟢`

❌ 编码前没写 AR → P0×4 + P1×7 + P2×7
✅ 编码前必须有独立 AR（`AR-M*-xxx.md`），覆盖：异常传播 / 副作用时序 / 安全检查 / 可配置项 / **并发安全（涉及状态变更的 service，是否存在"先查后改"？如有，WHERE 条件是否包含全部约束？禁止分两步）**。所有终端不可跳过
> 归因 A。详见 [postmortem-dev-38.md](../postmortems/postmortem-dev-38.md)

### DEV-34 SR 阶段门禁当建议跳过 → 实现与验证脱节 `🟢`

❌ SR 写了"T4 通过后进入阶段 B"，但 pytest 全绿就直接编码；ST 绕开 LLM 只测自动机
✅ SR 阶段门禁是硬性卡点；编码前回 SR 确认"当前阶段、前置 T 是否通过"；ST 对照 SR 验收标准逐条确认

### DEV-40 功能设计脱离基础设施现实 `🟢`

❌ SR 设计了"策略游戏 AI"级功能（4 种策略、双向定价、优先级），但底层调度是每小时 tick，策略执行绑在 LLM 决策同一个 tick 里 → 两层退化成一层，增加复杂度零收益
✅ SR 设计新功能时必须评估底层执行频率/调度架构是否匹配设计意图。**检查项：这个功能在当前调度周期下能发挥设计效果吗？如果不能，先改基础设施或降低功能预期**
> 归因 D。M6 P1/P1.1 策略系统：price_target 操盘需要秒级响应但只有小时级 tick，keep_working 每天只能 checkin 一次但每小时空转。

### DEV-42 对话开头的环境指令未执行就动手改文件 `🟢`

❌ 用户在对话开头说"用 worktree/切分支/在 XX 目录"，后续进入具体任务后遗忘，直接在 main 上改文件
✅ 第一次调用 Edit/Write/Bash(git) 之前，回溯对话开头确认：用户是否指定了工作环境（worktree/分支/目录）？指定了就先执行 EnterWorktree/git checkout，未就绪不动手
> 归因 A（DEV-4 变体）。环境指令 = 硬性前置条件，不是可选建议。

### DEV-41 用户要求拉角色但不读角色定义文件 `🟢`

❌ 用户说"拉起 XX 角色"，不读 `docs/personas/` 对应文件，自己用"XX 视角"瞎答
✅ 听到任何角色名 → 先 Read `docs/personas/` 对应角色文件 + `human-proxy-knowledge.md` → 用 Task 启 agent 时把角色定义完整传入 prompt
> 归因 A（DEV-4 变体）。角色定义 ≠ prompt 修饰词，是有知识库和行为准则的完整人格。

### DEV-43 CR 与五方评审混淆 `🟢`

❌ 编码完成后启动"五方评审"做代码审查，把 CR（代码评审）和 IR/SR/AR 阶段的五方评审混为一谈
✅ CR = 独立 agent 审查已提交代码（阶段 6a），用 P1/P2/P3 分级；五方评审 = 5 角色 agent 审查设计文档（阶段 0~1）。两者审查对象、参与方、所处阶段完全不同
> 根因：development-workflow.md 缺少 CR 阶段独立定义，编码终端看到"CR"不知道是什么就往五方评审上靠。已补阶段 6a 定义。

### DEV-39 前端改动跳过 UI 设计稿 + 美学验收 `🟡中频×2`

❌ 把前端改动当"后端顺手改几行"，跳过阶段 2.5（UI 设计稿）和阶段 6.5（独立 agent 美学验收），CSS 动画参数/颜色选择凭直觉；把美学审核合并到 CR 子 agent 里一笔带过
✅ 任何涉及可见 UI 变更的任务（新状态颜色、动画、布局、文案），编码前必须产出 UI 设计稿；编码后必须启独立 agent + Playwright 做美学验收。**美学审核是独立 gate，不能合并到 CR 里**。门控顺序：编码完成 → CR 自检（逐条 checklist）→ 美学审核（独立做：读 CSS 审配色/间距/响应式 → 读 TSX 审信息层级/空状态/a11y → 输出结论）→ 修复 → 再过一轮 → 才能进 UT。**判定标准：改了 .css/.tsx 中的可见元素 = 需要走 2.5 + 6.5**
> ×2：M6.2-P2 美学审核被合并到 CR 子 agent 输出里，只说"视觉层次清晰"空话，没自己读 CSS+TSX 做真正审查。根因：编码惯性，把门控当形式走。
> 归因 DEV-4×14。根因：低估前端改动视觉影响，心理上归类为"后端任务的附属"。

### DEV-45 批量/seed 操作幂等设计未考虑"部分成功"中间状态 `🟢`

❌ 照搬简单 seed 的幂等模式（`count > 0` 就跳过），但新 seed 涉及外部 API 调用（embedding），存在部分失败场景。首次 13 条中 3 条失败，重启后 `count > 0` 直接跳过，缺失条目永远无法补全
✅ 涉及外部依赖的批量操作，幂等检查必须用细粒度差集（按业务键比对已有 vs 待插入），而非粗粒度 `count > 0`。每条记录用 savepoint（`begin_nested`）包裹，单条失败不影响其他记录，重启可自愈
> 归因：M6.2-P4 公共记忆种子数据。照搬 `seed_jobs_and_items`（无外部依赖，不会部分失败）的幂等模式到有 embedding API 依赖的场景
> **美学验收必检项（DEV-BUG-20 补充）**：① hover 交互验证（Playwright `page.hover()` + 取背景计算值，确认与所在面板背景的对比度合理）② 动画舒适度（opacity 变化幅度 >0.5 = 闪烁风险，需人工确认或改用 glow/scale）③ CSS 变量上下文检查（变量语义是否匹配使用位置，如 sidebar 变量不能用在亮色面板）

### DEV-44 SR/AR 文档与代码签名不同步 + AR 风险面遗漏 `🟢`

❌ SR 写函数签名 `-> str`，实际实现 `-> str | None`；AR 风险表未覆盖"用户输入拼入 LLM prompt"
✅ SR 完成后对照代码实际签名做 diff；AR 风险表增加固定检查项：是否有用户可控内容拼入 LLM prompt
> M6.2-P1 CR P1-1/P1-3。文档是契约，签名不一致 = 契约违约；prompt 注入是 LLM 应用常见风险面。
