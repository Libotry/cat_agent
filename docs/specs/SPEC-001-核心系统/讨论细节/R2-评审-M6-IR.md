# M6 IR 第二轮五方评审纪要

> 状态：IR 已完成 → 进入 SR 阶段 | 遗留议题待 Phase 1 验证后再议

## 参与角色

- 架构师（Architect）
- 人类替身 PM（Human Proxy PM）
- 讨论专家（Discussion Expert）
- QA Lead
- Tech Lead

---

## 议题 1：M6 范围是否过大

### 背景

ROADMAP 中 M6 只写了三个关键词："持久进程 + 上网 + 任意工具调用"。IR 草稿将其展开为 6 个方向：

1. 事件驱动循环 — Agent 订阅城市事件，实时感知并自主行动
2. 上网搜索 — Agent 通过搜索引擎查询关键词
3. 网页抓取 — Agent 抓取指定 URL 内容
4. 代码执行沙箱 — Agent 在沙箱中跑 Python 代码
5. 长任务编排 — Agent 创建多步骤计划，系统自动推进
6. 状态可视化 — 前端展示 Agent 当前状态和行动日志

涉及 4 个独立技术域（事件系统、网络请求、代码沙箱、任务调度），Tech Lead 估算总工作量 15-20 天。

### 各方意见

- **架构师**：范围过大，建议拆分为 M6.1 核心 + M6.2/M6.3 可选
- **人类替身 PM**：严重过度设计，建议砍到 2-3 天的最简版本
- **Tech Lead**：技术可行但工作量大（20-25 天），建议分阶段
- **QA Lead**：测试面太广，安全测试需额外 14 条 AC
- **讨论专家**：建议拆 3 个子里程碑（核心 5-7 天 / 工具 3-5 天 / 高级 7-10 天）

### 共识

5/5 一致认为必须拆分。

### 用户决策

**待确认**

---

## 议题 2：事件驱动循环（F31）

### 背景

Agent 现在每小时醒一次（autonomy_loop），看一眼世界状态做决策，中间一小时发生的事完全不知道。比如农田 3 分钟前建好了，Agent 要等到下一个整点才发现；市场出现超低价卖单，等 Agent 醒来早被买走了。

M6 想让 Agent 能"订阅"关心的事件（建筑完工、市场新单等），事件发生时实时通知 Agent 评估要不要行动。

### 各方意见

- 5/5 一致认为这是 M6 最核心的能力，必须做
- 担忧：每个事件都触发 LLM 评估，调用量可能暴增
- 架构师推荐增强模式（保留 hourly tick + 新增事件触发路径）

### 用户反馈

- 硅基免费模型 L1 额度：RPM 1000 / TPM 50000，经计算够用
- 事件评估用免费小模型做过滤，只有通过的才触发完整 LLM 决策
- 用户关注的设计点：
  1. **关心订阅限流**：每个 Agent 最多订阅 N 种事件类型（如 3 种）
  2. **每小时响应次数**：每个 Agent 每小时最多响应 K 次（如 5 次），超了攒到 hourly tick
  3. **抖动**：事件触发后加随机延迟（5-30 秒），防 RPM 打满 + 模拟真人反应
  4. **hourly tick 保留**：作为兜底，事件驱动是"加餐"不是替代
- 用户提出**连锁反应雪崩风险**：类似股市开盘竞价，A 接单 → 触发价格变动 → B 响应 → B 挂新单 → C 响应……高频时段事件雪崩，挤占后续真正重要事件的预算

### 连锁反应雪崩防护

五方讨论了三个候选方案：
- A：只做事件合并（~0.5 天）
- B：合并 + 传播深度限制 depth 字段（~1 天）
- C：合并 + 深度 + 2 级优先级（~2 天）

架构师/Tech Lead/讨论专家提出了 chain_depth 方案（事件加 depth 整数字段，depth>=2 不再触发响应），实现成本极低。但用户偏向极简。

### 五方表态

- 雪崩防护方案：5/5 同意方案 A（只做合并）
- 合并窗口：3:2 分歧（30 秒 vs 60 秒），用户拍板 60 秒

### 用户决策（已废弃 → 被议题 2b 替代）

~~方案 A + 60 秒合并窗口~~ — 用户在讨论过程中提出了全新的"战略游戏 AI"方案，废弃合并去抖方案。

---

## 议题 2b：战略游戏 AI 两层架构（用户提出，替代原 F31 设计）

### 背景

用户在议题 2 讨论中提出：与其让每个事件都触发 LLM 评估，不如像红警/战略游戏 AI 一样，LLM 只负责定策略，自动机负责执行。

### 两层架构

1. **LLM 层（战略决策）**：每小时 hourly tick 时，LLM 看世界状态，输出"策略指令"而非"单次动作"
   - 例："小麦粉价格拉到 2.0 就停"
   - 例："持续在农田工作，直到小麦存量达到 50"
   - 例："如果有人卖小麦粉低于 1.5，立即接单"

2. **自动机层（策略执行）**：非 LLM 规则引擎，事件来了 → 匹配当前策略 → 匹配就执行，不匹配就忽略。零 API 成本。

### 对原方案的影响

| | 原 F31（事件驱动 + LLM 评估） | 新方案（策略自动机） |
|---|---|---|
| 事件响应 | 事件→小模型过滤→LLM 评估→行动 | 事件→自动机匹配策略→行动 |
| LLM 调用 | 每小时 tick + 每次事件评估 | 只有每小时 tick |
| 成本控制 | 需要合并/去抖/预算限制 | 不需要，自动机零成本 |
| Agent 行为模式 | 碎片式反应 | 持续策略执行，有"目标感" |
| 雪崩风险 | 需要防护机制 | 自然消失（毫秒级纯代码匹配） |

### 五方表态

**5/5 一致强烈支持。**

- **架构师**：可行，现有 autonomy_service decide→execute_decisions 架构改造路径清晰，tool_registry 可复用为自动机执行层
- **Tech Lead**：可行，改造量不大，零 API 成本 + 毫秒响应 + 无雪崩，收益远大于成本
- **QA Lead**：可行且测试友好度大幅提升，自动机是确定性逻辑可穷举断言。需要策略校验层 + fallback 默认策略
- **人类替身 PM**：强烈支持，完美契合"Agent 是居民"定位，成本问题直接消失
- **讨论专家**：支持，策略游戏 AI 是几十年验证过的成熟模式

### 策略指令设计共识

- 策略类型必须枚举化，不能让 LLM 自由发挥
- 先支持 3-5 种类型：
  - `price_target` — 价格目标（拉高/压低到目标价）
  - `stockpile` — 囤积资源（工作/购买直到存量达标）
  - `opportunistic_buy` — 条件接单（低于某价自动买入）
  - `keep_working` — 持续工作（留在当前建筑直到条件满足）
- 每条策略结构：`{type, condition, action, until, priority, ttl}`
- TTL = 3600 秒（下次 tick 前自动过期，LLM 可续期）
- LLM 输出不合法时走 fallback 默认策略
- 同 Agent 多策略用 priority 排序

### 用户决策（已确认）

**采用战略游戏 AI 两层架构，渐进式实现：**
- Phase 1（~1 天）：只做 `keep_working` + `opportunistic_buy`，验证可行性
- Phase 2（~1 天）：加 `price_target` + `stockpile`
- Phase 3（~0.5 天）：策略持久化 + 前端展示（配合 F35）
- Phase 1 验证后再决定是否继续。失败则退回现有 action 模式。
- 策略格式必须极简扁平（不嵌套），兜底：解析失败退化为单次 action
- 废弃议题 2 的合并/去抖方案

---

## 议题 3：M6 范围拆分

### 五方表态（5/5 一致）

| 功能 | 决定 | 理由 |
|---|---|---|
| F31 事件驱动 → 改为策略自动机 | M6 本体 | 核心能力，已确认 |
| F35 Agent 状态与行动日志 | M6 本体 | F31 的可观测性配套，没日志就是黑盒，工作量小（~1 天） |
| F32 上网工具 | 推迟 M6.3 | 偏通用 AI 助手，当前无场景驱动，等 F31 成熟后再加 |
| F33 代码沙箱 | 推迟 M6.3 | 同上 |
| F34 长任务编排 | 推迟 M6.3 | 依赖 F31 成熟后才有意义 |

**M6 本体 = F31（策略自动机）+ F35（状态日志），预估 3-4 天。**
**M6.3 = F32 + F33 + F34，待 M6 本体验证后再启动。**

### 用户决策（已确认）

- M6 本体：F31 + F35
- F32/F33/F34 全部推迟到 M6.3

---

## 后续议题（遗留，Phase 1 验证后再议）

- 议题 4：策略指令详细设计（完整类型枚举、数据结构、校验规则）— Phase 2 前讨论
- 议题 5：成本控制参数最终确认 — 策略自动机方案下成本模型已变，Phase 1 验证后重新评估
- 议题 6：IR 落盘定稿 — Phase 1 验证后根据结果更新 IR
