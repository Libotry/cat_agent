# 01-需求原型

> 产品需求概览。核心功能定义见 [00-产品愿景.md](00-产品愿景.md)，各里程碑详细需求见对应目录。

---

## 已完成里程碑

| 里程碑 | 目标 | 状态 |
|--------|------|------|
| M1 — 能跑起来 | Agent 能聊天，人类发消息 → Agent 自动回复 | ✅ 完成 |
| M2 — 有记忆有经济 | 记忆系统 + 经济系统 + 悬赏任务 | ✅ 完成 |
| M3 — 城市经济闭环 | 工作打卡 + 虚拟商店 + 城市 UI | ✅ 完成 |
| M4 — Agent 自主行为 | 世界状态驱动决策 + 自主行为引擎 + 动态 Feed | ✅ 完成 |
| M5 — 记忆系统 + 城市经济 | 建筑生产 + 三维属性 + 以物易物交易 + 记忆管理 | ✅ 完成 |
| M5.1 — 资源转赠 + Tool Use | Agent Tool Use 架构 + 资源转赠完善 + 交易面板 | ✅ 完成 |
| M5.2 — 交易市场 | 挂单/接单/撤单 + autonomy_loop + Tool Use + 前端市场面板 | 📋 已拆分，见 [M5.2-交易市场/](M5.2-交易市场/) |

---

## M6 Agent 运行时（持久进程 + 上网 + 扩展工具）

> 里程碑目标：让 Agent 从"被动响应"进化为"主动生存"。Agent 能够持续感知环境变化并自主行动（不依赖定时唤醒），能够访问互联网获取实时信息辅助决策，能够使用更丰富的工具类型（文件读写、代码执行、数据库查询等）完成复杂任务。

### 背景

当前 Agent 的行为驱动方式有三种：@提及唤醒、定时唤醒（每小时 batch）、autonomy_loop tick。这些都是"外部触发 → 单次响应"模式，Agent 无法持续运行、无法感知实时事件、无法执行长时间任务。

M5.1 建立了 Tool Use 框架（tool_registry + agent_runner tool_call 循环），但工具种类有限（transfer_resource、create_market_order 等城市经济工具）。Agent 无法上网搜索、无法读写文件、无法执行代码。

M6 要解决的核心问题：Agent 如何从"每小时醒一次的 NPC"变成"持续在线的自主个体"。

### 前置条件

- M5.1 Tool Use 框架已就绪（tool_registry + agent_runner tool_call 循环）
- M5.2 交易市场已就绪（Agent 有经济行为动机）
- M6.1 建造系统已就绪（Agent 有长周期任务场景）
- CLI 子进程方案已否决（通信层脆弱、与自主 Agent 愿景冲突），持久进程需在 Server 内实现

### 用户故事

**US-M6-1 Agent 持续感知与自主行动**
作为 Agent，我能够持续感知城市中的事件（建筑完工、市场价格变化、资源产出、其他 Agent 的行为），并在合适的时机自主做出反应，而不是等待每小时一次的定时唤醒。例如：建筑完工后立即分配工人，市场出现低价资源时立即接单。

**US-M6-2 Agent 上网搜索**
作为 Agent，我能够在决策过程中搜索互联网获取信息。例如：被问到实时新闻时能搜索回答，需要知识辅助决策时能查询资料。上网行为受经济系统约束（消耗 credits）。

**US-M6-3 Agent 网页抓取**
作为 Agent，我能够抓取指定 URL 的网页内容并提取关键信息。例如：监控某个价格页面、读取公告信息。抓取行为受频率限制和安全沙箱约束。

**US-M6-4 Agent 执行代码**
作为 Agent，我能够编写并执行简单的 Python 代码片段来完成计算任务。例如：计算最优交易策略、分析资源产出效率、统计历史数据。代码在安全沙箱中执行，有时间和资源限制。

**US-M6-5 Agent 长任务编排**
作为 Agent，我能够执行需要多步骤、跨时间的复杂任务。例如："收集 20 木材 → 建造磨坊 → 等待完工 → 分配工人 → 开始生产"这样的多步计划，Agent 能自动推进每一步，而不需要人工干预。

**US-M6-6 前端 Agent 状态可视化**
作为用户，我能够在前端看到每个 Agent 的运行状态（空闲/思考中/执行任务中）、当前正在执行的任务、最近的行动日志，以便了解 Agent 在做什么。

### 功能点

#### F31. Agent 事件驱动循环

- F31.1 Agent 能够订阅城市事件（建筑完工、资源产出、市场变动、聊天消息等）
- F31.2 事件触发时，Agent 的 LLM 评估是否需要行动（不是每个事件都响应）
- F31.3 Agent 有"注意力预算"：每小时最多响应 N 个事件，防止过度活跃
- F31.4 事件响应受经济系统约束（每次 LLM 调用消耗 credits）
- F31.5 Agent 可以设置关注的事件类型（个性化过滤）

#### F32. 上网工具

- F32.1 `web_search` 工具：Agent 通过搜索引擎查询关键词，返回摘要结果
- F32.2 `web_fetch` 工具：Agent 抓取指定 URL 内容，返回纯文本摘要
- F32.3 搜索和抓取结果经过安全过滤（去除脚本、限制内容长度）
- F32.4 每次上网操作消耗 credits（比普通聊天更贵）
- F32.5 频率限制：每个 Agent 每小时最多 M 次上网操作

#### F33. 代码执行工具

- F33.1 `run_code` 工具：Agent 提交 Python 代码片段，在沙箱中执行并返回 stdout/stderr
- F33.2 沙箱限制：执行时间上限（如 10 秒）、内存上限（如 128MB）、禁止网络访问和文件系统写入
- F33.3 预装常用库（math、json、datetime、collections 等标准库）
- F33.4 每次代码执行消耗 credits
- F33.5 执行结果自动截断（最大 2000 字符）

#### F34. 长任务编排

- F34.1 Agent 能够创建多步骤计划（plan），每步包含动作和前置条件
- F34.2 计划持久化存储，Server 重启后不丢失
- F34.3 当前置条件满足时（如建筑完工事件触发），自动推进到下一步
- F34.4 计划执行过程中 Agent 可以修改或取消计划
- F34.5 计划状态变化广播给前端（plan_step_completed 事件）
- F34.6 单个 Agent 同时最多 1 个活跃计划

#### F35. Agent 状态与行动日志

- F35.1 Agent 状态字段：idle / thinking / executing / planning
- F35.2 行动日志记录每次工具调用、事件响应、计划推进的摘要
- F35.3 前端展示 Agent 当前状态徽章 + 最近 N 条行动日志
- F35.4 行动日志通过 WebSocket 实时推送

### 非功能需求

- **NF-M6-1** 事件响应延迟：从事件发生到 Agent 开始评估 < 5 秒
- **NF-M6-2** 上网工具单次调用延迟 < 10 秒（含网络请求）
- **NF-M6-3** 代码沙箱执行延迟 < 10 秒（硬超时）
- **NF-M6-4** 10 个 Agent 同时在线时，Server 内存增量 < 200MB
- **NF-M6-5** Agent 事件循环崩溃不影响其他 Agent 和 Server 主进程
- **NF-M6-6** 上网工具不可访问内网地址（SSRF 防护）
- **NF-M6-7** 代码沙箱禁止 import os/subprocess/socket 等危险模块

### 验收标准

| ID | 场景 | 预期结果 |
|----|------|----------|
| AC-M6-01 | 建筑完工事件触发 | 相关 Agent 在 5 秒内评估并决定是否分配工人 |
| AC-M6-02 | 市场出现低价卖单 | 关注市场的 Agent 自动评估并可能接单 |
| AC-M6-03 | Agent 注意力预算耗尽 | 后续事件不再触发 LLM 评估，等待下一小时重置 |
| AC-M6-04 | Agent credits 为 0 | 事件响应停止，Agent 进入 idle 状态 |
| AC-M6-05 | 聊天中 @Agent "搜索一下今天的天气" | Agent 调用 web_search 工具，返回搜索结果并回复 |
| AC-M6-06 | Agent 自主决策上网搜索 | credits 正确扣除，搜索结果纳入决策上下文 |
| AC-M6-07 | web_fetch 目标为内网地址（127.0.0.1） | 请求被拒绝，返回 SSRF 防护错误 |
| AC-M6-08 | Agent 执行 `sum(range(100))` | 沙箱返回 4950，credits 扣除 |
| AC-M6-09 | Agent 执行 `import os; os.system('rm -rf /')` | 沙箱拒绝执行，返回安全错误 |
| AC-M6-10 | Agent 执行死循环代码 | 10 秒后超时终止，返回超时错误 |
| AC-M6-11 | Agent 创建多步计划"采集→建造→分配" | 计划持久化，第一步开始执行 |
| AC-M6-12 | 计划前置条件满足（建筑完工） | 自动推进到下一步（分配工人） |
| AC-M6-13 | Agent 取消进行中的计划 | 计划状态变为 cancelled，后续步骤不再执行 |
| AC-M6-14 | Server 重启 | 活跃计划恢复，从中断步骤继续 |
| AC-M6-15 | 前端查看 Agent 状态 | 显示当前状态徽章 + 最近行动日志 |
| AC-M6-16 | Agent 执行工具时 | 前端实时收到状态变化（idle→executing→idle） |

### 范围边界（M6 不做）

- Agent 间直接通信（Agent A 主动给 Agent B 发私信）— 留社交网络里程碑
- 多城市系统 / 跨城市迁移 — 留长期愿景
- Agent 自主创建新工具（元编程）— 复杂度过高，留远期
- 文件系统持久读写（Agent 拥有个人文件空间）— M6 代码执行仅限无状态沙箱
- GPU 加速 / 大规模计算任务 — 超出本地部署范围
- Agent 自主注册/注销（Agent 自己决定上下线）— 生命周期仍由 Server 管理
